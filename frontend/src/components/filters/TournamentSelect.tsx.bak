'use client';

import React, { useState, useCallback, useMemo } from 'react';
import { ChevronDown, Check, X } from 'lucide-react';
import { cn } from '@/lib/utils';

interface TournamentOption {
  id: string;
  name: string;
  year?: number;
  icon?: string;
  handCount?: number;
}

interface TournamentSelectProps {
  value: string[];
  onChange: (tournaments: string[]) => void;
  options: TournamentOption[];
  label?: string;
  placeholder?: string;
}

export function TournamentSelect({
  value,
  onChange,
  options,
  label = 'Tournament',
  placeholder = 'Select tournaments...',
}: TournamentSelectProps) {
  const [isOpen, setIsOpen] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');

  const groupedOptions = useMemo(() => {
    const grouped: Record<number, TournamentOption[]> = {};
    const sortedOptions = [...options].sort((a, b) => {
      const yearA = a.year || 0;
      const yearB = b.year || 0;
      return yearB - yearA;
    });

    for (const option of sortedOptions) {
      const year = option.year || 'Other';
      if (!grouped[year]) grouped[year] = [];
      grouped[year].push(option);
    }

    return Object.entries(grouped)
      .sort(([yearA], [yearB]) => {
        const a = yearA === 'Other' ? 0 : parseInt(yearA);
        const b = yearB === 'Other' ? 0 : parseInt(yearB);
        return b - a;
      })
      .map(([year, tournaments]) => ({
        year,
        tournaments: tournaments.sort((a, b) => a.name.localeCompare(b.name)),
      }));
  }, [options]);

  const filteredGroups = useMemo(() => {
    return groupedOptions
      .map((group) => ({
        year: group.year,
        tournaments: group.tournaments.filter((tournament) =>
          tournament.name.toLowerCase().includes(searchQuery.toLowerCase()),
        ),
      }))
      .filter((group) => group.tournaments.length > 0);
  }, [groupedOptions, searchQuery]);

  const handleToggle = useCallback(
    (tournamentId: string) => {
      onChange(
        value.includes(tournamentId)
          ? value.filter((id) => id !== tournamentId)
          : [...value, tournamentId],
      );
    },
    [value, onChange],
  );

  const handleSelectAll = useCallback(() => {
    const allIds = options.map((opt) => opt.id);
    onChange(allIds);
  }, [options, onChange]);

  const handleClearAll = useCallback(() => {
    onChange([]);
    setSearchQuery('');
  }, [onChange]);

  const selectedTournaments = options.filter((opt) => value.includes(opt.id));

  return (
    <div className="space-y-3">
      {/* Label */}
      <label className="block text-sm font-semibold text-gray-900" id="tournament-label">
        {label}
        {value.length > 0 && (
          <span className="ml-2 inline-block px-2.5 py-0.5 bg-blue-100 text-blue-700 text-xs font-medium rounded-full">
            {value.length}
          </span>
        )}
      </label>

      {/* Dropdown Button */}
      <button
        onClick={() => setIsOpen(!isOpen)}
        className={cn(
          'w-full flex items-center justify-between px-4 py-3 bg-white border-2 rounded-lg font-medium transition-all focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500',
          isOpen
            ? 'border-blue-500 bg-blue-50'
            : 'border-gray-300 hover:border-gray-400',
        )}
        aria-haspopup="listbox"
        aria-expanded={isOpen}
        aria-labelledby="tournament-label"
      >
        <span className="flex-1 text-left text-gray-900">
          {value.length === 0 ? (
            <span className="text-gray-500">{placeholder}</span>
          ) : value.length === 1 ? (
            selectedTournaments[0]?.name
          ) : (
            <span>{value.length} tournaments selected</span>
          )}
        </span>
        <ChevronDown
          className={cn(
            'w-5 h-5 text-gray-500 transition-transform',
            isOpen && 'rotate-180',
          )}
          aria-hidden="true"
        />
      </button>

      {/* Dropdown Menu */}
      {isOpen && (
        <div
          className="absolute z-50 w-full max-w-sm mt-1 bg-white rounded-lg border border-gray-300 shadow-lg overflow-hidden"
          role="listbox"
          aria-label="Tournament options"
        >
          {/* Search */}
          <div className="sticky top-0 p-3 bg-gray-50 border-b border-gray-200">
            <input
              type="text"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              placeholder="Search tournaments..."
              className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              aria-label="Search tournaments"
            />
          </div>

          {/* Control Buttons */}
          <div className="flex gap-2 p-3 border-b border-gray-200 bg-gray-50">
            <button
              onClick={handleSelectAll}
              className="flex-1 px-3 py-2 text-sm font-medium text-blue-600 hover:bg-blue-50 rounded transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500"
              aria-label="Select all tournaments"
            >
              Select All
            </button>
            {value.length > 0 && (
              <button
                onClick={handleClearAll}
                className="flex-1 px-3 py-2 text-sm font-medium text-red-600 hover:bg-red-50 rounded transition-colors focus:outline-none focus:ring-2 focus:ring-red-500"
                aria-label="Clear all selections"
              >
                Clear All
              </button>
            )}
          </div>

          {/* Options List */}
          {filteredGroups.length > 0 ? (
            <div className="max-h-72 overflow-y-auto">
              {filteredGroups.map((group) => (
                <div key={group.year}>
                  {/* Year Header */}
                  <div className="px-4 py-2 bg-gray-100 border-b border-gray-200 sticky top-14">
                    <span className="text-xs font-semibold text-gray-600 uppercase tracking-wider">
                      {group.year}
                    </span>
                  </div>

                  {/* Tournaments */}
                  {group.tournaments.map((tournament) => {
                    const isSelected = value.includes(tournament.id);
                    return (
                      <button
                        key={tournament.id}
                        onClick={() => handleToggle(tournament.id)}
                        role="option"
                        aria-selected={isSelected}
                        className={cn(
                          'w-full flex items-center justify-between px-4 py-3 text-left transition-colors focus:outline-none',
                          isSelected
                            ? 'bg-blue-50 border-l-4 border-blue-500'
                            : 'hover:bg-gray-50 border-l-4 border-transparent',
                        )}
                      >
                        <div className="flex-1 min-w-0">
                          <div className="font-medium text-gray-900 truncate">
                            {tournament.icon && (
                              <span className="mr-2">{tournament.icon}</span>
                            )}
                            {tournament.name}
                          </div>
                          {tournament.handCount && (
                            <div className="text-xs text-gray-500">
                              {tournament.handCount} hands
                            </div>
                          )}
                        </div>
                        {isSelected && (
                          <Check className="w-5 h-5 text-blue-600 ml-2 flex-shrink-0" />
                        )}
                      </button>
                    );
                  })}
                </div>
              ))}
            </div>
          ) : (
            <div className="px-4 py-8 text-center text-gray-500">
              <p className="text-sm">No tournaments found</p>
            </div>
          )}
        </div>
      )}

      {/* Selected Tags */}
      {value.length > 0 && (
        <div className="flex flex-wrap gap-2 p-3 bg-blue-50 rounded-lg border border-blue-200">
          {selectedTournaments.map((tournament) => (
            <div
              key={tournament.id}
              className="inline-flex items-center gap-2 px-3 py-1 bg-white rounded-full border border-blue-300 text-sm font-medium text-gray-900 shadow-sm"
            >
              {tournament.name}
              <button
                onClick={() => handleToggle(tournament.id)}
                className="p-0.5 hover:bg-gray-100 rounded-full transition-colors"
                aria-label={`Remove ${tournament.name}`}
                title={`Remove ${tournament.name}`}
              >
                <X className="w-4 h-4 text-gray-500" />
              </button>
            </div>
          ))}
        </div>
      )}

      {/* Help Text */}
      <p className="text-xs text-gray-500">
        Click dropdown to select • Use search to filter • {value.length} of {options.length} selected
      </p>
    </div>
  );
}
