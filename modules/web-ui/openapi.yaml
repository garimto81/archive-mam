openapi: 3.0.3

info:
  title: M6 Web UI Service API (BFF)
  description: |
    **POKER-BRAIN Web UI Service**

    사용자 인터페이스 및 Backend for Frontend (BFF) API입니다.

    **담당**: Frontend Engineer (Frank)
    **모듈 ID**: M6
    **배포**: Cloud Run (us-central1) 또는 Vercel
    **Tech Stack**: Next.js 14 (App Router) + shadcn/ui

    ## 주요 기능
    - 포커 핸드 검색 UI
    - 프록시 영상 미리보기
    - 클립 다운로드 요청 및 상태 조회
    - 즐겨찾기 관리
    - 관리자 대시보드 (Phase 0 진행률)

    ## BFF 패턴
    ```
    Browser (React) → Next.js API Routes (BFF)
        ↓
    BFF → M4 (RAG Search)
    BFF → M5 (Clipping)
    BFF → M3 (Timecode Validation, Admin)
        ↓
    Browser ← JSON Response
    ```

    ## 페이지 구조
    ```
    /                    → 검색 페이지
    /search?q=...        → 검색 결과
    /hand/[hand_id]      → 핸드 상세 + 미리보기
    /downloads           → 내 다운로드 목록
    /favorites           → 즐겨찾기
    /admin               → 관리자 대시보드
    ```

    ## 의존성
    - **Upstream**: M4 (Search), M5 (Clipping), M3 (Admin)
    - **Auth**: Google IAP (자동)

  version: 1.0.0
  contact:
    name: GG Production Frontend Team
    email: aiden.kim@ggproduction.net

servers:
  - url: https://poker-brain-{env}.run.app
    description: Cloud Run deployment
    variables:
      env:
        default: prod
        enum:
          - prod
          - staging
          - dev
  - url: http://localhost:3000
    description: Local development (Next.js)

tags:
  - name: Search
    description: 검색 관련 API (BFF)
  - name: Download
    description: 다운로드 관련 API (BFF)
  - name: User
    description: 사용자 기능
  - name: Admin
    description: 관리자 기능

paths:
  /api/search:
    post:
      summary: 포커 핸드 검색 (BFF)
      description: |
        M4 RAG Search Service를 호출하여 검색 결과를 반환합니다.

        **BFF 역할**:
        - M4 API 호출
        - 에러 핸들링
        - 사용자 컨텍스트 추가 (email, favorites)
        - 응답 변환
      operationId: search
      tags:
        - Search
      security:
        - CookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SearchRequest'
            example:
              query: "Tom Dwan 블러프"
              filters:
                year_range: [2008, 2024]
              limit: 20
      responses:
        '200':
          description: 검색 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchResponse'
              example:
                query_id: "search-20241117-001"
                total_results: 156
                results:
                  - hand_id: "wsop2008_me_d3_h154"
                    summary: "Tom Dwan, J4o, river all-in bluff vs Phil Hellmuth"
                    proxy_url: "https://storage.googleapis.com/..."
                    is_favorite: false
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/download:
    post:
      summary: 클립 다운로드 요청 (BFF)
      description: |
        M5 Clipping Service를 호출하여 클립 생성을 요청합니다.

        **BFF 역할**:
        - BigQuery에서 hand 정보 조회
        - M5 API 호출 (POST /v1/clip/request)
        - 다운로드 이력 저장
      operationId: download
      tags:
        - Download
      security:
        - CookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DownloadRequest'
            example:
              hand_id: "wsop2024_me_d3_h154"
      responses:
        '200':
          description: 다운로드 요청 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DownloadResponse'
              example:
                clip_request_id: "clip-20241117-001"
                status: "queued"
                message: "클립 생성 중입니다. 5분 내 완료됩니다."
                estimated_completion: "2024-11-17T14:05:00Z"
        '404':
          $ref: '#/components/responses/NotFound'

  /api/download/{clip_request_id}/status:
    get:
      summary: 다운로드 상태 조회 (BFF)
      description: |
        M5 Clipping Service의 상태를 조회합니다.

        **Polling 권장**: 5초 간격으로 상태 확인
      operationId: getDownloadStatus
      tags:
        - Download
      security:
        - CookieAuth: []
      parameters:
        - name: clip_request_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 상태 조회 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DownloadStatus'
              examples:
                completed:
                  summary: 완료됨
                  value:
                    clip_request_id: "clip-20241117-001"
                    status: "completed"
                    download_url: "https://storage.googleapis.com/gg-subclips/...?X-Goog-Signature=..."
                    file_size_bytes: 52428800
                    download_url_expires_at: "2024-11-17T21:00:00Z"
                processing:
                  summary: 처리 중
                  value:
                    clip_request_id: "clip-20241117-002"
                    status: "processing"
                    progress_percent: 65

  /api/favorites:
    get:
      summary: 즐겨찾기 목록 조회
      operationId: getFavorites
      tags:
        - User
      security:
        - CookieAuth: []
      responses:
        '200':
          description: 즐겨찾기 목록
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                  favorites:
                    type: array
                    items:
                      $ref: '#/components/schemas/HandSummary'
    post:
      summary: 즐겨찾기 추가
      operationId: addFavorite
      tags:
        - User
      security:
        - CookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                hand_id:
                  type: string
      responses:
        '200':
          description: 추가 완료
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "added"
    delete:
      summary: 즐겨찾기 제거
      operationId: removeFavorite
      tags:
        - User
      security:
        - CookieAuth: []
      parameters:
        - name: hand_id
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 제거 완료

  /api/downloads/history:
    get:
      summary: 내 다운로드 이력
      operationId: getDownloadHistory
      tags:
        - User
      security:
        - CookieAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: 다운로드 이력
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                  downloads:
                    type: array
                    items:
                      type: object
                      properties:
                        clip_request_id:
                          type: string
                        hand_id:
                          type: string
                        status:
                          type: string
                        download_url:
                          type: string
                          nullable: true
                        requested_at:
                          type: string
                          format: date-time

  /api/admin/validation/stats:
    get:
      summary: 타임코드 검증 통계 (관리자)
      description: |
        M3 Timecode Validation 진행 상황을 조회합니다.

        **Phase 0 대시보드용**
      operationId: getValidationStats
      tags:
        - Admin
      security:
        - CookieAuth: []
      responses:
        '200':
          description: 검증 통계
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationStats'
              example:
                total_hands: 125000
                validated_hands: 98500
                validation_rate: 0.788
                perfect_sync_count: 75000
                offset_needed_count: 18500
                manual_needed_count: 5000

  /api/admin/validation/manual:
    get:
      summary: 수동 매칭 필요 목록 (관리자)
      description: |
        sync_score < 60인 핸드 목록을 반환합니다.

        **수동 매칭 UI용**
      operationId: getManualMatchNeeded
      tags:
        - Admin
      security:
        - CookieAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
      responses:
        '200':
          description: 수동 매칭 필요 목록
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                  hands:
                    type: array
                    items:
                      type: object
                      properties:
                        hand_id:
                          type: string
                        sync_score:
                          type: number
                        event_name:
                          type: string
                        proxy_url:
                          type: string

  /health:
    get:
      summary: 헬스 체크
      operationId: healthCheck
      responses:
        '200':
          description: 서비스 정상
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "healthy"
                  uptime_seconds:
                    type: integer
                  dependencies:
                    type: object
                    properties:
                      m4_search:
                        type: string
                      m5_clipping:
                        type: string

components:
  schemas:
    SearchRequest:
      type: object
      required:
        - query
      properties:
        query:
          type: string
          minLength: 2
        filters:
          type: object
          properties:
            players:
              type: array
              items:
                type: string
            event_name_contains:
              type: string
            year_range:
              type: array
              items:
                type: integer
            pot_size_min:
              type: number
        limit:
          type: integer
          default: 20

    SearchResponse:
      type: object
      properties:
        query_id:
          type: string
        total_results:
          type: integer
        results:
          type: array
          items:
            $ref: '#/components/schemas/HandSummary'

    HandSummary:
      type: object
      properties:
        hand_id:
          type: string
        summary:
          type: string
        event_name:
          type: string
        timestamp_start:
          type: string
          format: date-time
        proxy_url:
          type: string
          nullable: true
        players:
          type: array
          items:
            type: string
        pot_size_usd:
          type: number
        is_favorite:
          type: boolean
          description: 현재 사용자의 즐겨찾기 여부

    DownloadRequest:
      type: object
      required:
        - hand_id
      properties:
        hand_id:
          type: string

    DownloadResponse:
      type: object
      properties:
        clip_request_id:
          type: string
        status:
          type: string
          enum: [queued, processing]
        message:
          type: string
        estimated_completion:
          type: string
          format: date-time

    DownloadStatus:
      type: object
      properties:
        clip_request_id:
          type: string
        status:
          type: string
          enum: [queued, processing, completed, failed]
        progress_percent:
          type: integer
          nullable: true
        download_url:
          type: string
          nullable: true
        file_size_bytes:
          type: integer
          nullable: true
        download_url_expires_at:
          type: string
          format: date-time
          nullable: true
        error_message:
          type: string
          nullable: true

    ValidationStats:
      type: object
      properties:
        total_hands:
          type: integer
        validated_hands:
          type: integer
        validation_rate:
          type: number
        perfect_sync_count:
          type: integer
        offset_needed_count:
          type: integer
        manual_needed_count:
          type: integer

    Error:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string
        timestamp:
          type: string
          format: date-time

  responses:
    BadRequest:
      description: 잘못된 요청
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFound:
      description: 리소스를 찾을 수 없음
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    InternalError:
      description: 내부 서버 오류
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

  securitySchemes:
    CookieAuth:
      type: apiKey
      in: cookie
      name: __Secure-next-auth.session-token
      description: Next-Auth session cookie (IAP 통합)

security:
  - CookieAuth: []
