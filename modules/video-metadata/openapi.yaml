openapi: 3.0.3

info:
  title: M2 Video Metadata Service API
  description: |
    **POKER-BRAIN Video Metadata Service**

    NAS 영상 파일을 스캔하여 메타데이터를 추출하고 720p 프록시 영상을 생성하는 서비스입니다.

    **담당**: Backend Engineer (Bob)
    **모듈 ID**: M2
    **배포**: Cloud Run (us-central1)

    ## 주요 기능
    - NAS 디렉토리 스캔 (재귀 탐색)
    - FFmpeg 메타데이터 추출 (해상도, 코덱, 길이, 파일 크기)
    - 720p H.264 프록시 영상 생성 및 GCS 업로드
    - BigQuery `video_files` 테이블 관리

    ## 의존성
    - **Input**: NAS Mount Point (/nas/poker/)
    - **Output**: BigQuery Table (prod.video_files), GCS (프록시)
    - **Trigger**: Cron (일 1회) 또는 수동 API 호출

  version: 1.0.0
  contact:
    name: GG Production Video Team
    email: aiden.kim@ggproduction.net

servers:
  - url: https://video-metadata-service-{env}.run.app
    description: Cloud Run deployment
    variables:
      env:
        default: prod
        enum:
          - prod
          - staging
          - dev
  - url: http://localhost:8002
    description: Local development

tags:
  - name: Scanning
    description: NAS 영상 파일 스캔
  - name: Metadata
    description: 메타데이터 조회
  - name: Proxy
    description: 프록시 영상 생성
  - name: Monitoring
    description: 서비스 상태

paths:
  /v1/scan:
    post:
      summary: NAS 디렉토리 스캔 시작
      description: |
        NAS 영상 파일을 재귀적으로 스캔하여 메타데이터를 추출합니다.

        **처리 과정**:
        1. NAS 경로 검증
        2. 영상 파일 탐색 (.mp4, .mov, .avi 등)
        3. FFmpeg로 메타데이터 추출
        4. (옵션) 720p 프록시 생성
        5. BigQuery 적재

        **예상 처리 시간**: 150 files → ~1시간
      operationId: startScan
      tags:
        - Scanning
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ScanRequest'
            examples:
              wsop_2024:
                summary: WSOP 2024 전체 스캔
                value:
                  nas_path: "/nas/poker/2024/wsop/"
                  recursive: true
                  generate_proxy: true
                  proxy_resolution: "720p"
              single_day:
                summary: 특정 일자만 스캔
                value:
                  nas_path: "/nas/poker/2024/wsop/main_event/day3/"
                  recursive: false
                  generate_proxy: false
      responses:
        '200':
          description: 스캔 작업이 성공적으로 시작됨
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScanResponse'
              example:
                scan_id: "scan-20241117-001"
                status: "running"
                total_files: 150
                processed_files: 0
                estimated_duration_sec: 3600
                started_at: "2024-11-17T10:30:00Z"
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/scan/{scan_id}/status:
    get:
      summary: 스캔 작업 상태 조회
      description: |
        진행 중이거나 완료된 스캔 작업의 상태를 조회합니다.

        **상태 종류**:
        - `running`: 스캔 진행 중
        - `completed`: 스캔 완료
        - `failed`: 스캔 실패
        - `cancelled`: 스캔 취소됨
      operationId: getScanStatus
      tags:
        - Scanning
      security:
        - BearerAuth: []
      parameters:
        - name: scan_id
          in: path
          required: true
          description: 스캔 작업 ID
          schema:
            type: string
            pattern: '^scan-\d{8}-\d{3}$'
          example: "scan-20241117-001"
      responses:
        '200':
          description: 스캔 상태 조회 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScanStatus'
              examples:
                completed:
                  summary: 완료된 스캔
                  value:
                    scan_id: "scan-20241117-001"
                    status: "completed"
                    total_files: 150
                    processed_files: 148
                    failed_files: 2
                    duration_sec: 3600
                    proxy_generated: 145
                    started_at: "2024-11-17T10:30:00Z"
                    completed_at: "2024-11-17T11:30:00Z"
                    failed_files_list:
                      - file_path: "/nas/poker/2024/wsop/corrupted.mp4"
                        error: "Invalid video format"
                running:
                  summary: 진행 중인 스캔
                  value:
                    scan_id: "scan-20241117-002"
                    status: "running"
                    total_files: 200
                    processed_files: 85
                    failed_files: 3
                    duration_sec: 1800
                    proxy_generated: 82
                    started_at: "2024-11-17T12:00:00Z"
                    completed_at: null
                    failed_files_list: []
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /v1/files/{file_id}:
    get:
      summary: 영상 파일 메타데이터 조회
      description: |
        특정 영상 파일의 상세 메타데이터를 조회합니다.

        **포함 정보**:
        - 파일 기본 정보 (경로, 크기, 생성일)
        - 영상 스펙 (해상도, 코덱, 길이)
        - 프록시 GCS 경로
      operationId: getFileMetadata
      tags:
        - Metadata
      security:
        - BearerAuth: []
      parameters:
        - name: file_id
          in: path
          required: true
          description: 파일 고유 ID
          schema:
            type: string
          example: "vid_wsop2024_me_d3"
      responses:
        '200':
          description: 메타데이터 조회 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VideoFile'
              example:
                file_id: "vid_wsop2024_me_d3"
                nas_path: "/nas/poker/2024/wsop/main_event_day3.mp4"
                file_name: "main_event_day3.mp4"
                event_id: "wsop2024_me"
                file_size_bytes: 52428800000
                duration_seconds: 36000
                resolution: "1920x1080"
                codec: "h264"
                bitrate_kbps: 11520
                fps: 29.97
                proxy_gcs_path: "gs://gg-proxy/wsop2024_me_d3_720p.mp4"
                proxy_url: "https://storage.googleapis.com/gg-proxy/wsop2024_me_d3_720p.mp4"
                is_archived: false
                created_at: "2024-07-15T10:00:00Z"
                scanned_at: "2024-11-17T10:35:42Z"
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /v1/files:
    get:
      summary: 영상 파일 목록 조회
      description: |
        조건에 맞는 영상 파일 목록을 조회합니다.

        **필터링 옵션**:
        - event_id: 특정 이벤트
        - date_range: 날짜 범위
        - has_proxy: 프록시 생성 여부
      operationId: listFiles
      tags:
        - Metadata
      security:
        - BearerAuth: []
      parameters:
        - name: event_id
          in: query
          description: 이벤트 ID로 필터링
          schema:
            type: string
          example: "wsop2024_me"
        - name: date_from
          in: query
          description: 시작 날짜 (YYYY-MM-DD)
          schema:
            type: string
            format: date
          example: "2024-07-01"
        - name: date_to
          in: query
          description: 종료 날짜 (YYYY-MM-DD)
          schema:
            type: string
            format: date
          example: "2024-07-31"
        - name: has_proxy
          in: query
          description: 프록시 생성 여부
          schema:
            type: boolean
          example: true
        - name: limit
          in: query
          description: 결과 개수 제한
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
        - name: offset
          in: query
          description: 페이징 오프셋
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: 파일 목록 조회 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                    description: 전체 결과 수
                  limit:
                    type: integer
                  offset:
                    type: integer
                  files:
                    type: array
                    items:
                      $ref: '#/components/schemas/VideoFile'
              example:
                total: 1250
                limit: 100
                offset: 0
                files:
                  - file_id: "vid_wsop2024_me_d3"
                    nas_path: "/nas/poker/2024/wsop/main_event_day3.mp4"
                    duration_seconds: 36000
                    resolution: "1920x1080"
                    proxy_gcs_path: "gs://gg-proxy/wsop2024_me_d3_720p.mp4"
        '401':
          $ref: '#/components/responses/Unauthorized'

  /v1/proxy/generate:
    post:
      summary: 프록시 영상 생성 (단일 파일)
      description: |
        특정 파일의 720p 프록시 영상을 생성합니다.

        **처리 과정**:
        1. NAS 원본 파일 읽기
        2. FFmpeg 720p 트랜스코딩
        3. GCS 업로드
        4. BigQuery 업데이트

        **예상 처리 시간**: 10시간 영상 → ~20분
      operationId: generateProxy
      tags:
        - Proxy
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProxyRequest'
            example:
              file_id: "vid_wsop2024_me_d3"
              resolution: "720p"
              quality: "medium"
      responses:
        '200':
          description: 프록시 생성 작업 시작됨
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProxyResponse'
              example:
                proxy_job_id: "proxy-20241117-001"
                file_id: "vid_wsop2024_me_d3"
                status: "processing"
                estimated_duration_sec: 1200
                output_gcs_path: "gs://gg-proxy/wsop2024_me_d3_720p.mp4"
                started_at: "2024-11-17T14:00:00Z"
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /v1/proxy/{proxy_job_id}/status:
    get:
      summary: 프록시 생성 상태 조회
      operationId: getProxyStatus
      tags:
        - Proxy
      security:
        - BearerAuth: []
      parameters:
        - name: proxy_job_id
          in: path
          required: true
          schema:
            type: string
            pattern: '^proxy-\d{8}-\d{3}$'
          example: "proxy-20241117-001"
      responses:
        '200':
          description: 프록시 생성 상태
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProxyStatus'
              example:
                proxy_job_id: "proxy-20241117-001"
                file_id: "vid_wsop2024_me_d3"
                status: "completed"
                duration_sec: 1150
                output_gcs_path: "gs://gg-proxy/wsop2024_me_d3_720p.mp4"
                output_url: "https://storage.googleapis.com/gg-proxy/wsop2024_me_d3_720p.mp4"
                output_size_bytes: 5242880000
                completed_at: "2024-11-17T14:19:10Z"
        '404':
          $ref: '#/components/responses/NotFound'

  /v1/stats:
    get:
      summary: 전체 스캔 통계 조회
      operationId: getStats
      tags:
        - Monitoring
      security:
        - BearerAuth: []
      parameters:
        - name: period
          in: query
          schema:
            type: string
            enum: [24h, 7d, 30d, all]
            default: 24h
      responses:
        '200':
          description: 통계 조회 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Stats'
              example:
                period: "24h"
                total_files_scanned: 450
                total_files_in_db: 125000
                total_storage_bytes: 52428800000000
                proxies_generated: 380
                avg_scan_time_per_file_sec: 8.5
                last_scan_at: "2024-11-17T10:30:00Z"

  /health:
    get:
      summary: 헬스 체크
      operationId: healthCheck
      tags:
        - Monitoring
      responses:
        '200':
          description: 서비스 정상
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [healthy, degraded]
                  version:
                    type: string
                  uptime_seconds:
                    type: integer
                  dependencies:
                    type: object
                    properties:
                      nas:
                        type: string
                        enum: [ok, error]
                      bigquery:
                        type: string
                        enum: [ok, error]
                      gcs:
                        type: string
                        enum: [ok, error]
              example:
                status: "healthy"
                version: "1.0.0"
                uptime_seconds: 86400
                dependencies:
                  nas: "ok"
                  bigquery: "ok"
                  gcs: "ok"

components:
  schemas:
    ScanRequest:
      type: object
      required:
        - nas_path
      properties:
        nas_path:
          type: string
          description: NAS 디렉토리 경로
          pattern: '^/nas/poker/.*'
          example: "/nas/poker/2024/wsop/"
        recursive:
          type: boolean
          description: 하위 디렉토리 재귀 탐색 여부
          default: true
        generate_proxy:
          type: boolean
          description: 720p 프록시 생성 여부
          default: true
        proxy_resolution:
          type: string
          enum: ["720p", "480p"]
          description: 프록시 해상도
          default: "720p"
        file_extensions:
          type: array
          description: 스캔할 파일 확장자 (기본값: mp4, mov, avi)
          items:
            type: string
          example: ["mp4", "mov"]

    ScanResponse:
      type: object
      properties:
        scan_id:
          type: string
          pattern: '^scan-\d{8}-\d{3}$'
        status:
          type: string
          enum: [running, queued]
        total_files:
          type: integer
          description: 발견된 총 파일 수
        processed_files:
          type: integer
        estimated_duration_sec:
          type: integer
        started_at:
          type: string
          format: date-time

    ScanStatus:
      type: object
      properties:
        scan_id:
          type: string
        status:
          type: string
          enum: [running, completed, failed, cancelled]
        total_files:
          type: integer
        processed_files:
          type: integer
        failed_files:
          type: integer
        duration_sec:
          type: integer
        proxy_generated:
          type: integer
          description: 생성된 프록시 수
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
          nullable: true
        failed_files_list:
          type: array
          items:
            type: object
            properties:
              file_path:
                type: string
              error:
                type: string

    VideoFile:
      type: object
      properties:
        file_id:
          type: string
          description: 파일 고유 ID
        nas_path:
          type: string
          description: NAS 절대 경로
        file_name:
          type: string
        event_id:
          type: string
          nullable: true
        file_size_bytes:
          type: integer
          format: int64
        duration_seconds:
          type: number
          format: float
        resolution:
          type: string
          example: "1920x1080"
        codec:
          type: string
          example: "h264"
        bitrate_kbps:
          type: integer
        fps:
          type: number
          format: float
        proxy_gcs_path:
          type: string
          nullable: true
          description: GCS 프록시 경로
        proxy_url:
          type: string
          nullable: true
          description: 프록시 다운로드 URL
        is_archived:
          type: boolean
        created_at:
          type: string
          format: date-time
        scanned_at:
          type: string
          format: date-time

    ProxyRequest:
      type: object
      required:
        - file_id
      properties:
        file_id:
          type: string
        resolution:
          type: string
          enum: ["720p", "480p"]
          default: "720p"
        quality:
          type: string
          enum: [high, medium, low]
          default: "medium"
          description: |
            - high: CRF 18 (높은 품질, 큰 파일)
            - medium: CRF 23 (균형)
            - low: CRF 28 (낮은 품질, 작은 파일)

    ProxyResponse:
      type: object
      properties:
        proxy_job_id:
          type: string
        file_id:
          type: string
        status:
          type: string
          enum: [processing, queued]
        estimated_duration_sec:
          type: integer
        output_gcs_path:
          type: string
        started_at:
          type: string
          format: date-time

    ProxyStatus:
      type: object
      properties:
        proxy_job_id:
          type: string
        file_id:
          type: string
        status:
          type: string
          enum: [processing, completed, failed]
        duration_sec:
          type: integer
        output_gcs_path:
          type: string
        output_url:
          type: string
          nullable: true
        output_size_bytes:
          type: integer
          format: int64
        error_message:
          type: string
          nullable: true
        completed_at:
          type: string
          format: date-time
          nullable: true

    Stats:
      type: object
      properties:
        period:
          type: string
          enum: [24h, 7d, 30d, all]
        total_files_scanned:
          type: integer
        total_files_in_db:
          type: integer
        total_storage_bytes:
          type: integer
          format: int64
        proxies_generated:
          type: integer
        avg_scan_time_per_file_sec:
          type: number
          format: float
        last_scan_at:
          type: string
          format: date-time

    Error:
      type: object
      required:
        - error
        - request_id
        - timestamp
      properties:
        error:
          type: object
          properties:
            code:
              type: string
              enum:
                - INVALID_REQUEST
                - UNAUTHORIZED
                - FORBIDDEN
                - NOT_FOUND
                - INTERNAL_ERROR
                - SERVICE_UNAVAILABLE
            message:
              type: string
            details:
              type: object
        request_id:
          type: string
        timestamp:
          type: string
          format: date-time

  responses:
    BadRequest:
      description: 잘못된 요청
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error:
              code: "INVALID_REQUEST"
              message: "nas_path must start with '/nas/poker/'"
              details:
                field: "nas_path"
            request_id: "req-20241117-001"
            timestamp: "2024-11-17T10:30:00Z"

    Unauthorized:
      description: 인증 실패
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFound:
      description: 리소스를 찾을 수 없음
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error:
              code: "NOT_FOUND"
              message: "File not found"
              details:
                file_id: "vid_unknown"
            request_id: "req-20241117-002"
            timestamp: "2024-11-17T10:30:00Z"

    InternalError:
      description: 내부 서버 오류
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Google IAP JWT Token

security:
  - BearerAuth: []
