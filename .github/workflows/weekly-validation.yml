name: POKER-BRAIN Weekly Validation

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      week:
        description: 'Week number to validate (1-9)'
        required: true
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '4'
          - '5'
          - '6'
          - '7'
          - '8'
          - '9'
          - 'all'

  # Scheduled weekly validation (every Monday 9 AM KST)
  schedule:
    - cron: '0 0 * * 1'  # 00:00 UTC = 09:00 KST every Monday

  # Trigger on specific branch pushes
  push:
    branches:
      - main
      - 'week-*'
    paths:
      - 'modules/**'
      - 'm*/**'
      - '.validation/**'

env:
  PYTHON_VERSION: '3.11'
  GCLOUD_PROJECT_ID: 'gg-poker'
  GCLOUD_REGION: 'us-central1'

jobs:
  determine-week:
    name: Determine Current Week
    runs-on: ubuntu-latest
    outputs:
      current_week: ${{ steps.detect.outputs.week }}
      should_run: ${{ steps.detect.outputs.should_run }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect current week
        id: detect
        run: |
          # Manual trigger
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "week=${{ inputs.week }}" >> $GITHUB_OUTPUT
            echo "should_run=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Auto-detect from .validation/current-week.txt
          if [ -f ".validation/current-week.txt" ]; then
            WEEK=$(cat .validation/current-week.txt)
            echo "week=$WEEK" >> $GITHUB_OUTPUT
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "week=1" >> $GITHUB_OUTPUT
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  validate-week-1-2:
    name: Validate Week 1-2 (API + Mock)
    runs-on: ubuntu-latest
    needs: determine-week
    if: needs.determine-week.outputs.should_run == 'true' && (needs.determine-week.outputs.current_week == '1' || needs.determine-week.outputs.current_week == '2' || needs.determine-week.outputs.current_week == 'all')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install pyyaml google-cloud-bigquery google-cloud-pubsub requests

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Run Week 1-2 validation
        id: validate
        run: |
          python scripts/run_weekly_validator.py --week 1-2 --max-attempts 3
        continue-on-error: true

      - name: Upload validation results
        uses: actions/upload-artifact@v3
        with:
          name: week-1-2-validation-results
          path: .validation/week-1-2-result.json

      - name: Notify on failure
        if: steps.validate.outcome == 'failure'
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "ğŸš¨ Week 1-2 Validation Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Week 1-2 ê²€ì¦ ì‹¤íŒ¨*\n\nOpenAPI ìŠ¤í™ ë˜ëŠ” Mock í™˜ê²½ ì„¤ì •ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.\n\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|GitHub Actions ë¡œê·¸ ë³´ê¸°>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  validate-week-4:
    name: Validate Week 4 (M1 Complete)
    runs-on: ubuntu-latest
    needs: determine-week
    if: needs.determine-week.outputs.should_run == 'true' && (needs.determine-week.outputs.current_week == '4' || needs.determine-week.outputs.current_week == 'all')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install google-cloud-bigquery google-cloud-run requests apache-beam[gcp]

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Run Week 4 validation
        id: validate
        run: |
          python scripts/run_weekly_validator.py --week 4 --max-attempts 3
        continue-on-error: true

      - name: Upload validation results
        uses: actions/upload-artifact@v3
        with:
          name: week-4-validation-results
          path: .validation/week-4-result.json

      - name: Notify on failure
        if: steps.validate.outcome == 'failure'
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "ğŸš¨ Week 4 Validation Failed - M1 Incomplete",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Week 4 (M1 ì™„ë£Œ) ê²€ì¦ ì‹¤íŒ¨*\n\nDataflow, BigQuery ë˜ëŠ” API ë°°í¬ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.\n\n@Alice ì¦‰ì‹œ í™•ì¸ í•„ìš”\n\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|GitHub Actions ë¡œê·¸ ë³´ê¸°>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  validate-week-5:
    name: Validate Week 5 (Mock â†’ Real)
    runs-on: ubuntu-latest
    needs: determine-week
    if: needs.determine-week.outputs.should_run == 'true' && (needs.determine-week.outputs.current_week == '5' || needs.determine-week.outputs.current_week == 'all')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install google-cloud-bigquery google-cloud-pubsub requests

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Run Week 5 validation
        id: validate
        run: |
          python scripts/run_weekly_validator.py --week 5 --max-attempts 3
        continue-on-error: true

      - name: Upload validation results
        uses: actions/upload-artifact@v3
        with:
          name: week-5-validation-results
          path: .validation/week-5-result.json

      - name: Notify on failure
        if: steps.validate.outcome == 'failure'
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "ğŸš¨ Week 5 Validation Failed - Mock â†’ Real Transition Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Week 5 (Mock â†’ Real ì „í™˜) ê²€ì¦ ì‹¤íŒ¨*\n\nM3, M4, M5, M6 ì¤‘ ì¼ë¶€ê°€ Real í™˜ê²½ ì „í™˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\n@team í™˜ê²½ ë³€ìˆ˜ ë° API ì—°ê²° í™•ì¸ í•„ìš”\n\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|GitHub Actions ë¡œê·¸ ë³´ê¸°>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  validate-week-7-8:
    name: Validate Week 7-8 (E2E Tests)
    runs-on: ubuntu-latest
    needs: determine-week
    if: needs.determine-week.outputs.should_run == 'true' && (needs.determine-week.outputs.current_week == '7' || needs.determine-week.outputs.current_week == '8' || needs.determine-week.outputs.current_week == 'all')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Playwright
        run: |
          cd m6-web-ui
          npm ci
          npx playwright install --with-deps

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Run Week 7-8 validation
        id: validate
        run: |
          python scripts/run_weekly_validator.py --week 7-8 --max-attempts 3
        continue-on-error: true

      - name: Upload Playwright report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: playwright-report
          path: m6-web-ui/playwright-report/

      - name: Upload validation results
        uses: actions/upload-artifact@v3
        with:
          name: week-7-8-validation-results
          path: .validation/week-7-8-result.json

      - name: Notify on failure
        if: steps.validate.outcome == 'failure'
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "ğŸš¨ Week 7-8 E2E Tests Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Week 7-8 (E2E í…ŒìŠ¤íŠ¸) ê²€ì¦ ì‹¤íŒ¨*\n\nE2E í…ŒìŠ¤íŠ¸ í†µê³¼ìœ¨ì´ ëª©í‘œì— ë¯¸ë‹¬í–ˆìŠµë‹ˆë‹¤.\n\nâ€¢ Week 7 ëª©í‘œ: 80% í†µê³¼\nâ€¢ Week 8 ëª©í‘œ: 100% í†µê³¼\n\n@team ë²„ê·¸ ìˆ˜ì • í•„ìš”\n\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|GitHub Actions ë¡œê·¸ ë³´ê¸°>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  validate-week-9:
    name: Validate Week 9 (Production Deploy)
    runs-on: ubuntu-latest
    needs: determine-week
    if: needs.determine-week.outputs.should_run == 'true' && (needs.determine-week.outputs.current_week == '9' || needs.determine-week.outputs.current_week == 'all')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install google-cloud-bigquery google-cloud-run requests

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Run Week 9 validation
        id: validate
        run: |
          python scripts/run_weekly_validator.py --week 9 --max-attempts 3
        continue-on-error: true

      - name: Upload validation results
        uses: actions/upload-artifact@v3
        with:
          name: week-9-validation-results
          path: .validation/week-9-result.json

      - name: Upload final report
        uses: actions/upload-artifact@v3
        if: steps.validate.outcome == 'success'
        with:
          name: final-report
          path: .validation/final-report.json

      - name: Notify on success
        if: steps.validate.outcome == 'success'
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "ğŸ‰ POKER-BRAIN Production Deployment Complete!",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ğŸ‰ POKER-BRAIN í”„ë¡œì íŠ¸ ì™„ë£Œ!*\n\nâœ… Production ë°°í¬ ì™„ë£Œ\nâœ… E2E í…ŒìŠ¤íŠ¸ 100% í†µê³¼\nâœ… ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ ë™ì‘\n\nğŸš€ Production URL: https://poker-brain.ggproduction.net\n\nğŸ¾ ëŸ°ì¹˜ íŒŒí‹°: ê¸ˆìš”ì¼ 18:00\n\n@aiden.kim @team ì¶•í•˜í•©ë‹ˆë‹¤!"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify on failure
        if: steps.validate.outcome == 'failure'
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "ğŸš¨ Week 9 Production Deployment Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Week 9 (Production ë°°í¬) ê²€ì¦ ì‹¤íŒ¨*\n\nâš ï¸ ìë™ ë¡¤ë°± ì‹¤í–‰ë¨\n\n@aiden.kim ì¦‰ì‹œ ê°œì… í•„ìš”\n\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|GitHub Actions ë¡œê·¸ ë³´ê¸°>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-week-1-2, validate-week-4, validate-week-5, validate-week-7-8, validate-week-9]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v3

      - name: Generate summary report
        run: |
          python scripts/generate_validation_summary.py

      - name: Upload summary
        uses: actions/upload-artifact@v3
        with:
          name: validation-summary
          path: .validation/summary.md

      - name: Post summary to PR
        if: github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('.validation/summary.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
